---
- name: Ensure UFW is installed
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: true

- name: Allow TCP ports (base + extra + SSH safety)
  vars:
    # Prevent lockouts by always allowing:
    # - the target SSH port configured by the role
    # - the current Ansible connection port (if different)
    security_ufw_allow_tcp_effective: >-
      {{
        (
          security_ufw_allow_tcp_base
          + security_ufw_allow_tcp_extra
          + [security_ssh_port | int]
          + [(ansible_port | default(security_ssh_port) | int)]
        ) | unique
      }}
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop: "{{ security_ufw_allow_tcp_effective }}"
  throttle: 1

- name: Allow UDP ranges (base + per-host extra)
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: udp
  loop: "{{ (security_ufw_allow_udp_ranges_base + security_ufw_allow_udp_ranges_extra) | unique }}"
  throttle: 1

- name: Default deny incoming
  community.general.ufw:
    direction: incoming
    policy: deny
  throttle: 1

- name: Default allow outgoing
  community.general.ufw:
    direction: outgoing
    policy: allow
  throttle: 1

- name: Enable UFW
  community.general.ufw:
    state: enabled
  throttle: 1
